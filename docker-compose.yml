services:
  csa:
    build: .
    container_name: csa-runner
    volumes:
      - ./reports:/app/reports
    networks:
      - sandbox
    depends_on:
      target:
        condition: service_healthy
      defender:
        condition: service_healthy
    deploy:
      resources:
        limits:
          memory: 1g
          cpus: "2.0"
    restart: on-failure

  target:
    image: python:3.12-slim
    container_name: csa-target
    command: ["python", "-m", "http.server", "8080"]
    networks:
      - sandbox
    healthcheck:
      test: ["CMD", "python", "-c", "import urllib.request; urllib.request.urlopen('http://localhost:8080')"]
      interval: 5s
      timeout: 3s
      retries: 3
    deploy:
      resources:
        limits:
          memory: 512m
          cpus: "1.0"
    restart: on-failure
    # Placeholder: replace with actual target service

  defender:
    image: python:3.12-slim
    container_name: csa-defender
    command: ["python", "-m", "http.server", "9090"]
    networks:
      - sandbox
    healthcheck:
      test: ["CMD", "python", "-c", "import urllib.request; urllib.request.urlopen('http://localhost:9090')"]
      interval: 5s
      timeout: 3s
      retries: 3
    deploy:
      resources:
        limits:
          memory: 512m
          cpus: "1.0"
    restart: on-failure
    # Placeholder: replace with defender monitoring service

networks:
  sandbox:
    driver: bridge
    internal: true  # No external internet access for isolation
